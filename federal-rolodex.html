<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federal Cases Rolodex</title>
    <style>
        body {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Top Navigation Bar */
        .top-nav {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            background: linear-gradient(135deg, rgba(0, 20, 0, 0.9) 0%, rgba(0, 40, 0, 0.8) 100%);
            border: 1px solid #00ff00;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            animation: pulse 3s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.3); }
            50% { box-shadow: 0 0 30px rgba(0, 255, 0, 0.5); }
        }

        .nav-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 40px;
            background: transparent;
            border: none;
            color: #00ff00;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
        }

        .nav-button:hover {
            background: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
        }

        .nav-button.active {
            background: rgba(0, 255, 0, 0.3);
        }

        /* Dropdown Styles */
        .dropdown {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            max-height: 500px;
            background: linear-gradient(135deg, rgba(0, 20, 0, 0.95) 0%, rgba(0, 40, 0, 0.90) 100%);
            border: 1px solid #00ff00;
            border-radius: 10px;
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.4);
            z-index: 999;
            display: none;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        .dropdown.show {
            display: block;
            animation: dropdownFade 0.3s ease-in-out;
        }

        @keyframes dropdownFade {
            from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .dropdown-header {
            padding: 15px;
            border-bottom: 1px solid rgba(0, 255, 0, 0.3);
            font-weight: bold;
            text-align: center;
            background: rgba(0, 255, 0, 0.1);
        }

        /* Search Dropdown */
        .search-input {
            width: calc(100% - 30px);
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ff00;
            border-radius: 5px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            margin: 15px 15px 0 15px;
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .search-result-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .search-result-item:hover {
            background: rgba(0, 255, 0, 0.2);
            border-left-color: #00ff00;
        }

        .search-result-case {
            font-weight: bold;
            font-size: 12px;
            color: #ffffff;
        }

        .search-result-title {
            font-size: 14px;
            margin: 3px 0;
            color: #00ff00;
        }

        .search-result-meta {
            font-size: 10px;
            color: #00cccc;
        }

        /* Saved Cases Dropdown */
        .saved-cases-list {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .saved-case-item {
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 0, 0.1);
            border: 1px solid rgba(255, 255, 0, 0.3);
            border-radius: 5px;
            position: relative;
            transition: all 0.3s ease;
        }

        .saved-case-item:hover {
            background: rgba(255, 255, 0, 0.2);
        }

        .saved-case-remove {
            position: absolute;
            top: 5px;
            right: 8px;
            background: none;
            border: none;
            color: #ff4444;
            cursor: pointer;
            font-size: 16px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .saved-case-remove:hover {
            background: rgba(255, 68, 68, 0.2);
        }

        .container {
            display: flex;
            width: 100vw;
            height: 100vh;
            box-sizing: border-box;
            align-items: center;
            justify-content: center;
            gap: 30px;
            padding: 60px 20px 20px 20px; /* Top padding for nav bar */
        }

        /* Desktop Layout */
        @media (min-width: 1025px) {
            .container {
                flex-direction: row;
            }

            .rolodex-container {
                flex: 2;
                max-width: 600px;
            }

            .new-cases-container {
                flex: 1;
                max-width: 400px;
                height: 500px;
            }
        }

        /* Desktop ONLY - Fixes positioning without affecting mobile */
        @media (min-width: 1025px) {
            .container {
                flex-direction: row;
                justify-content: center;
                align-items: flex-start;
                padding: 60px 40px 20px 40px;
                gap: 40px;
            }

            .rolodex-container {
                flex: 1;
                max-width: 600px;
                margin-left: 0;
                margin-right: 40px;
            }

            .rolodex-wrapper {
                overflow: visible;
                margin: 0 auto;
                max-width: 500px;
            }

            .card {
                left: 50%;
                transform: translateX(-50%);
                width: 500px;
                max-width: 500px;
                margin-left: 0;
                min-width: 500px;
            }

            .new-cases-container {
                flex: 0 0 400px;
                max-width: 400px;
            }
        }

        /* Ultra-wide desktop - Prevents stretching */
        @media (min-width: 1600px) {
            .container {
                max-width: 1400px;
                margin: 0 auto;
            }

            .card {
                width: 500px;
                transform: translateX(-50%);
            }
        }

        /* Tablet Landscape (between mobile landscape and desktop) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                flex-direction: row;
            }

            .rolodex-container {
                flex: 2;
                max-width: 600px;
            }

            .new-cases-container {
                flex: 1;
                max-width: 400px;
                height: 500px;
            }
        }

        /* Portrait Mobile/Tablet */
        @media (max-width: 768px) and (orientation: portrait) {
            .container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
                gap: 20px;
                padding: 60px 5px 5px 5px;
            }

            .rolodex-container {
                width: 100%;
                flex: none;
            }

            .new-cases-container {
                width: 100%;
                flex: none;
                height: 350px;
                margin: 0 10px;
            }

            .dropdown {
                width: 95%;
                max-width: 350px;
            }
        }

        /* Landscape Mobile/Tablet */
        @media (max-width: 768px) and (orientation: landscape) {
            .container {
                flex-direction: row;
                gap: 10px;
                padding: 50px 10px 10px 10px;
                justify-content: center;
            }

            .rolodex-container {
                flex: 1;
                max-width: 500px;
                margin: 0 auto;
            }

            .new-cases-container {
                flex: 1;
                max-width: 300px;
                height: 300px;
            }

            .dropdown {
                width: 90%;
                max-width: 400px;
            }
        }

        .rolodex-container {
            perspective: 1200px;
            perspective-origin: center center;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .rolodex-title {
            color: #00ff00;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 80px;
            text-shadow: 0 0 10px #00ff00;
            padding: 0 20px;
        }

        @media (max-width: 768px) {
            .rolodex-title {
                font-size: 18px;
                margin-bottom: 60px;
            }
        }

        .rolodex-wrapper {
            position: relative;
            width: 100%;
            max-width: 700px;
            height: 400px;
            transform-style: preserve-3d;
            margin: 0 auto;
            overflow: hidden;
        }

        @media (max-width: 768px) and (orientation: portrait) {
            .rolodex-wrapper {
                height: 250px;
                max-width: 100vw;
                overflow: visible;
            }
        }

        @media (max-width: 768px) and (orientation: landscape) {
            .rolodex-wrapper {
                height: 300px;
                max-width: 480px;
                margin: 0 auto;
            }
        }

        .rolodex {
            position: absolute;
            top: 40%;
            left: 50%;
            width: 100%;
            height: 80px;
            transform-style: preserve-3d;
            transform-origin: center center;
            transform: translate(-50%, -50%);
            cursor: grab;
            user-select: none;
        }

        .rolodex:active {
            cursor: grabbing;
        }

        .card {
            position: absolute;
            width: min(72vw, 540px);
            height: 72px;
            background: linear-gradient(135deg, #001100 0%, #003300 50%, #001100 100%);
            border: 2px solid #00ff00;
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 18px;
            box-sizing: border-box;
            box-shadow:
                0 0 15px rgba(0, 255, 0, 0.3),
                inset 0 0 15px rgba(0, 255, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            color: #00ff00;
            transform-origin: center center;
            backface-visibility: hidden;
            left: 50%;
            border-left-width: 5px;
        }

        .card.criminal {
            border-left-color: #ff0000;
        }

        .card.civil {
            border-left-color: #0088ff;
        }

        .card.other {
            border-left-color: #00ff00;
        }

        @media (max-width: 768px) and (orientation: portrait) {
            .card {
                width: 85vw;
                max-width: 450px;
                min-height: 72px;
                height: auto;
                padding: 8px 13px;
                left: 50%;
                transform: translateX(-50%);
                align-items: flex-start;
            }

            .card-content {
                align-items: flex-start;
            }
        }

        /* Mobile landscape - working rule */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .card {
                width: 480px;
                max-width: 480px;
                height: 90px;
                padding: 0 15px;
                left: 50%;
                transform: translateX(-50%);
            }

            .rolodex-container {
                perspective: 3000px;
            }

            .rolodex {
                transform: translate(-50%, -50%);
            }
        }

        .card:hover {
            background: linear-gradient(135deg, #002200 0%, #004400 50%, #002200 100%);
            box-shadow:
                0 0 25px rgba(0, 255, 0, 0.5),
                inset 0 0 20px rgba(0, 255, 0, 0.2);
            scale: 1.05;
        }

        .card-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .case-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 0;
            flex: 1;
        }

        .case-number {
            font-weight: bold;
            color: #ffffff;
            font-size: 14px;
        }

        .case-title {
            color: #00ff00;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(min(72vw, 540px) - 120px);
            flex-shrink: 1;
        }

        @media (max-width: 768px) and (orientation: portrait) {
            .case-title {
                font-size: 14px;
                max-width: calc(85vw - 100px);
            }

            .case-number {
                font-size: 12px;
            }

            .case-meta {
                font-size: 10px;
                gap: 8px;
            }
        }

        @media (max-width: 768px) and (orientation: landscape) {
            .case-title {
                font-size: 13px;
                max-width: calc(67.5vw - 100px);
            }

            .case-number {
                font-size: 11px;
            }

            .case-meta {
                font-size: 9px;
                gap: 8px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .case-title {
                font-size: 14px;
                max-width: calc(min(72vw, 540px) - 100px);
            }

            .case-number {
                font-size: 12px;
            }

            .case-meta {
                font-size: 10px;
            }
        }

        .case-meta {
            color: #00cccc;
            font-size: 12px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .case-meta span {
            white-space: nowrap;
            flex-shrink: 0;
        }

        .new-cases-container {
            background: linear-gradient(180deg, #001100 0%, #002200 100%);
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            overflow-y: auto;
            box-sizing: border-box;
        }

        @media (max-width: 768px) and (orientation: portrait) {
            .new-cases-container {
                padding: 15px;
            }
        }

        @media (max-width: 1024px) and (orientation: landscape) {
            .new-cases-container {
                padding: 12px;
                font-size: 12px;
            }
        }

        .new-cases-title {
            color: #ffff00;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 0 8px #ffff00;
        }

        .new-case-item {
            background: rgba(255, 255, 0, 0.1);
            border: 1px solid rgba(255, 255, 0, 0.3);
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .new-case-item:hover {
            background: rgba(255, 255, 0, 0.2);
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.4);
        }

        .new-case-number {
            color: #ffffff;
            font-weight: bold;
            font-size: 12px;
        }

        .new-case-title {
            color: #ffff00;
            font-size: 14px;
            margin: 5px 0;
        }

        .new-case-date {
            color: #00cccc;
            font-size: 10px;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            align-items: center;
            justify-content: center;
        }

        .control-btn {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .page-info {
            color: #00ff00;
            font-size: 14px;
        }

        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.1;
        }

        .loading-text {
            color: #ffd700;
            text-align: center;
            padding: 50px;
            font-size: 18px;
        }

        .stats {
            margin-top: 20px;
            text-align: center;
            color: #00ff00;
            font-size: 12px;
            opacity: 0.8;
        }

        @keyframes matrix-fall {
            to {
                transform: translateY(100vh);
                opacity: 0;
            }
        }

        /* Modal overlay styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .modal-card {
            width: min(72vw, 540px);
            height: 72px;
            background: linear-gradient(135deg, #001100 0%, #003300 50%, #001100 100%);
            border: 2px solid #00ff00;
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 18px;
            box-sizing: border-box;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.8);
            color: #00ff00;
            margin-bottom: 20px;
            transform: scale(1.1);
        }

        .copy-menu {
            background: rgba(0, 20, 0, 0.95);
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
        }

        .copy-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .copy-buttons button {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .copy-buttons button:hover {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .copy-notification {
            position: fixed;
            top: 60px;
            right: 20px;
            background: rgba(0, 255, 0, 0.9);
            color: black;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 2000;
            font-family: 'Courier New', monospace;
            transition: opacity 0.3s;
        }

        .copy-notification.fade-out {
            opacity: 0;
        }

        /* Lock rolodex when modal is open */
        .rolodex-locked {
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="matrix-bg" id="matrix-bg"></div>

    <!-- Top Navigation -->
    <div class="top-nav" id="top-nav">
        <button class="nav-button" id="saved-btn" title="Saved Cases">📁</button>
        <button class="nav-button" id="search-btn" title="Search Cases">🔍</button>
        <button class="nav-button" id="cost-btn" title="PACER Cost Tracker">💲</button>
        <button class="nav-button" id="filter-btn" title="Filter Cases">🔽</button>
        <button class="nav-button" id="sort-btn" title="Sort Cases">⇅</button>
    </div>

    <!-- Search Dropdown -->
    <div class="dropdown" id="search-dropdown">
        <div class="dropdown-header">SEARCH FEDERAL CASES</div>
        <input type="text" class="search-input" id="search-input" placeholder="Type case number, title, court...">
        <div class="search-results" id="search-results"></div>
    </div>

    <!-- Saved Cases Dropdown -->
    <div class="dropdown" id="saved-dropdown">
        <div class="dropdown-header">SAVED CASES (<span id="saved-count">0</span>)</div>
        <div class="saved-cases-list" id="saved-cases-list">
            <div style="text-align: center; color: #666; padding: 20px;">No saved cases yet</div>
        </div>
    </div>

    <!-- Cost Tracker Dropdown -->
    <div class="dropdown" id="cost-dropdown">
        <div class="dropdown-header">PACER COST TRACKER</div>
        <div style="padding: 20px; text-align: center; color: #00ff00;">
            <p>Cost tracking coming soon...</p>
            <p style="font-size: 10px; color: #666; margin-top: 10px;">$0.10 per page • Free under $30/quarter</p>
        </div>
    </div>

    <!-- Filter Dropdown -->
    <div class="dropdown" id="filter-dropdown">
        <div class="dropdown-header">FILTER CASES</div>
        <div style="padding: 15px;">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #00ff00;">Case Type:</label>
                <select id="filter-case-type" style="width: 100%; padding: 8px; background: rgba(0,0,0,0.7); border: 1px solid #00ff00; color: #00ff00; border-radius: 4px;">
                    <option value="all">All Types</option>
                    <option value="criminal">Criminal</option>
                    <option value="civil">Civil</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #00ff00;">District:</label>
                <input type="text" id="filter-district" placeholder="Enter district name..." style="width: calc(100% - 16px); padding: 8px; background: rgba(0,0,0,0.7); border: 1px solid #00ff00; color: #00ff00; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #00ff00;">Date Range:</label>
                <input type="date" id="filter-date-from" style="width: calc(50% - 10px); padding: 8px; background: rgba(0,0,0,0.7); border: 1px solid #00ff00; color: #00ff00; border-radius: 4px; margin-right: 5px;">
                <input type="date" id="filter-date-to" style="width: calc(50% - 10px); padding: 8px; background: rgba(0,0,0,0.7); border: 1px solid #00ff00; color: #00ff00; border-radius: 4px;">
            </div>
            <button onclick="rolodex.applyFilters()" style="width: 100%; padding: 10px; background: rgba(0,255,0,0.2); border: 1px solid #00ff00; color: #00ff00; border-radius: 4px; cursor: pointer; font-family: 'Courier New', monospace;">Apply Filters</button>
            <button onclick="rolodex.clearFilters()" style="width: 100%; padding: 10px; margin-top: 5px; background: rgba(255,0,0,0.2); border: 1px solid #ff0000; color: #ff0000; border-radius: 4px; cursor: pointer; font-family: 'Courier New', monospace;">Clear Filters</button>
        </div>
    </div>

    <!-- Sort Dropdown -->
    <div class="dropdown" id="sort-dropdown">
        <div class="dropdown-header">SORT CASES</div>
        <div class="copy-buttons" style="padding: 15px; flex-direction: column;">
            <button onclick="rolodex.applySortOption('newest')" style="width: 100%; margin: 5px 0;">📅 Newest First (Default)</button>
            <button onclick="rolodex.applySortOption('oldest')" style="width: 100%; margin: 5px 0;">📅 Oldest First</button>
            <button onclick="rolodex.applySortOption('alphabetical')" style="width: 100%; margin: 5px 0;">🔤 Alphabetical</button>
            <button onclick="rolodex.applySortOption('district')" style="width: 100%; margin: 5px 0;">🏛️ By District</button>
        </div>
    </div>

    <div class="loading-text" id="loading">
        >> Loading Federal Cases Database...
    </div>

    <div class="container" id="main-container" style="display: none;">
        <div class="rolodex-container">
            <div class="rolodex-title">FEDERAL CASE ARCHIVE</div>
            <div class="rolodex-wrapper">
                <div class="rolodex" id="rolodex">
                    <!-- Cards will be populated here -->
                </div>
            </div>
            <div class="controls">
                <button class="control-btn" id="prev-btn">← PREV</button>
                <div class="page-info">
                    Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                </div>
                <button class="control-btn" id="next-btn">NEXT →</button>
            </div>
            <div class="stats" id="stats">
                Showing <span id="case-count">0</span> total cases
                (<span id="new-cases-count" style="color: #00ff00;">0 new</span>) |
                Updated: <span id="last-updated">Never</span>
            </div>
        </div>

        <div class="new-cases-container">
            <div class="new-cases-title">RECENT FILINGS</div>
            <div id="new-cases-list">
                <!-- New cases will be populated here -->
            </div>
        </div>
    </div>

    <script>
    class FederalCaseRolodex {
        constructor() {
            this.allCases = [];
            this.newCases = [];
            this.currentPage = 0;
            this.casesPerPage = 9;
            this.totalPages = 0;
            this.selectedCardId = null;
            this.isCardSelected = false;
            this.currentRotation = 0;
            this.isDragging = false;
            this.startY = 0;
            this.startRotation = 0;
            this.velocity = 0;
            this.lastMoveTime = 0;
            this.lastMoveY = 0;
            this.isRolodexLocked = false;
            this.selectedCard = null;
            this.selectedCaseData = null;
            this.savedCases = [];
            this.searchResults = [];
            this.mergeStats = null;  // Store merge statistics from JSON

            this.init();
            window.rolodex = this; // Make accessible for popup buttons
        }

        async init() {
            await this.loadCases();
            this.loadSavedCases();
            this.setupMatrixBackground();
            this.setupRolodex();
            this.setupControls();
            this.setupInteractions();
            this.setupNavigation();
            this.restoreSessionState();
        }

        // Session state management
        saveSessionState() {
            const state = {
                currentPage: this.currentPage,
                currentRotation: this.currentRotation,
                timestamp: Date.now()
            };
            try {
                sessionStorage.setItem('rolodexState', JSON.stringify(state));
            } catch (e) {
                console.log('Could not save session state');
            }
        }

        restoreSessionState() {
            try {
                const savedState = sessionStorage.getItem('rolodexState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    // Only restore if saved within last hour
                    if (Date.now() - state.timestamp < 3600000) {
                        this.currentPage = Math.min(state.currentPage, this.totalPages - 1);
                        this.currentRotation = state.currentRotation;
                        this.renderRolodex();
                        this.updatePageInfo();
                        this.updateRolodexRotation();
                    }
                }
            } catch (e) {
                console.log('Could not restore session state');
            }
        }

        // Saved cases management
        loadSavedCases() {
            try {
                const saved = localStorage.getItem('savedFederalCases');
                if (saved) {
                    this.savedCases = JSON.parse(saved);
                    this.updateSavedCasesDisplay();
                }
            } catch (e) {
                console.log('Could not load saved cases');
                this.savedCases = [];
            }
        }

        saveCasesToStorage() {
            try {
                localStorage.setItem('savedFederalCases', JSON.stringify(this.savedCases));
                this.updateSavedCasesDisplay();
                this.showNotification('Cases saved to browser storage');
            } catch (e) {
                this.showNotification('Could not save cases');
            }
        }

        addSavedCase(caseData) {
            // Check if already saved
            if (!this.savedCases.find(c => c.id === caseData.id)) {
                this.savedCases.push({
                    ...caseData,
                    savedAt: new Date().toISOString()
                });
                this.saveCasesToStorage();
                this.showNotification('Case saved successfully');
            } else {
                this.showNotification('Case already saved');
            }
        }

        removeSavedCase(caseId) {
            this.savedCases = this.savedCases.filter(c => c.id !== caseId);
            this.saveCasesToStorage();
            this.showNotification('Case removed from saved list');
        }

        updateSavedCasesDisplay() {
            const savedList = document.getElementById('saved-cases-list');
            const savedCount = document.getElementById('saved-count');
            
            savedCount.textContent = this.savedCases.length;

            if (this.savedCases.length === 0) {
                savedList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No saved cases yet</div>';
                return;
            }

            savedList.innerHTML = this.savedCases.map(case_ => {
                const title = case_.title;
                const vsMatch = title.match(/^(.+?)\s+v\.?\s+(.+)$/i);
                
                return `
                    <div class="saved-case-item" onclick="rolodex.openSavedCase('${case_.id}')">
                        <button class="saved-case-remove" onclick="event.stopPropagation(); rolodex.removeSavedCase('${case_.id}')" title="Remove case">×</button>
                        <div class="new-case-number">${case_.id}</div>
                        <div class="new-case-title">${vsMatch ? `${vsMatch[1]} v. ${vsMatch[2]}` : title}</div>
                        <div class="new-case-date">${case_.filed_date} • ${case_.court}</div>
                    </div>
                `;
            }).join('');
        }

        openSavedCase(caseId) {
            const case_ = this.savedCases.find(c => c.id === caseId);
            if (case_ && case_.url && case_.url !== '#') {
                window.open(case_.url, '_blank');
            } else if (case_) {
                this.showNotification('No PACER URL available for this case');
            }
        }

        // Search functionality
        setupSearch() {
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            let searchTimeout;

            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.toLowerCase().trim();
                
                if (query.length < 2) {
                    searchResults.innerHTML = '';
                    return;
                }

                searchTimeout = setTimeout(() => {
                    this.performSearch(query);
                }, 200);
            });

            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const firstResult = searchResults.querySelector('.search-result-item');
                    if (firstResult) {
                        firstResult.click();
                    }
                }
            });
        }

        performSearch(query) {
            const searchResults = document.getElementById('search-results');
            
            // Search through all cases
            const matches = this.allCases.filter(case_ => {
                const searchText = `${case_.id} ${case_.title} ${case_.court} ${case_.case_type}`.toLowerCase();
                return searchText.includes(query);
            }).slice(0, 10); // Limit to 10 results

            if (matches.length === 0) {
                searchResults.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No matches found</div>';
                return;
            }

            searchResults.innerHTML = matches.map(case_ => {
                const title = case_.title;
                const vsMatch = title.match(/^(.+?)\s+v\.?\s+(.+)$/i);
                
                return `
                    <div class="search-result-item" onclick="rolodex.jumpToCase('${case_.id}')">
                        <div class="search-result-case">${case_.id}</div>
                        <div class="search-result-title">${vsMatch ? `${vsMatch[1]} v. ${vsMatch[2]}` : title}</div>
                        <div class="search-result-meta">${case_.case_type} • ${case_.court} • ${case_.filed_date}</div>
                    </div>
                `;
            }).join('');
        }

        jumpToCase(caseId) {
            // Find the case and its page
            const caseIndex = this.allCases.findIndex(c => c.id === caseId);
            if (caseIndex === -1) return;

            const targetPage = Math.floor(caseIndex / this.casesPerPage);
            const positionInPage = caseIndex % this.casesPerPage;
            
            // Navigate to the page
            this.currentPage = targetPage;
            this.renderRolodex();
            this.updatePageInfo();
            
            // Rotate to show the specific case at front
            const targetRotation = -(positionInPage / this.casesPerPage) * 360;
            this.animateToRotation(targetRotation);
            
            // Close search dropdown
            this.toggleDropdown('search', false);
            
            this.saveSessionState();
        }

        animateToRotation(targetRotation) {
            const startRotation = this.currentRotation;
            const deltaRotation = targetRotation - startRotation;
            const duration = 800;
            const startTime = Date.now();

            const animate = () => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Ease-out animation
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                
                this.currentRotation = startRotation + (deltaRotation * easeProgress);
                this.updateRolodexRotation();
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            };
            
            requestAnimationFrame(animate);
        }

        // Navigation setup
        setupNavigation() {
            const savedBtn = document.getElementById('saved-btn');
            const searchBtn = document.getElementById('search-btn');
            const costBtn = document.getElementById('cost-btn');
            const filterBtn = document.getElementById('filter-btn');
            const sortBtn = document.getElementById('sort-btn');

            savedBtn.addEventListener('click', () => this.toggleDropdown('saved'));
            searchBtn.addEventListener('click', () => this.toggleDropdown('search'));
            costBtn.addEventListener('click', () => this.toggleDropdown('cost'));
            filterBtn.addEventListener('click', () => this.toggleDropdown('filter'));
            sortBtn.addEventListener('click', () => this.toggleDropdown('sort'));

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown') && !e.target.closest('.nav-button')) {
                    this.closeAllDropdowns();
                }
            });

            this.setupSearch();
        }

        toggleDropdown(type, force = null) {
            const dropdowns = ['saved', 'search', 'cost', 'filter', 'sort'];

            // Close all dropdowns except the one being toggled
            dropdowns.forEach(dropdownType => {
                const dropdown = document.getElementById(`${dropdownType}-dropdown`);
                const btn = document.getElementById(`${dropdownType}-btn`);

                if (dropdownType === type) {
                    const isOpen = force !== null ? !force : dropdown.classList.contains('show');
                    if (!isOpen) {
                        dropdown.classList.add('show');
                        btn.classList.add('active');
                        if (type === 'search') {
                            document.getElementById('search-input').focus();
                        }
                    } else {
                        dropdown.classList.remove('show');
                        btn.classList.remove('active');
                    }
                } else {
                    dropdown.classList.remove('show');
                    btn.classList.remove('active');
                }
            });
        }

        closeAllDropdowns() {
            const dropdowns = ['saved', 'search', 'cost', 'filter', 'sort'];
            dropdowns.forEach(type => {
                document.getElementById(`${type}-dropdown`).classList.remove('show');
                document.getElementById(`${type}-btn`).classList.remove('active');
            });
        }

        async loadCases() {
            try {
                console.log('Loading federal case data from enhanced_federal_report.json - 357 cases expected');
                const response = await fetch('./enhanced_federal_report.json');
                if (response.ok) {
                    const data = await response.json();

                    // Combine regular cases and party cases
                    const regularCases = data.all_results.regular_cases.map(case_ => ({
                        id: case_.case_number,
                        title: case_.case_title,
                        court: case_.court_name || case_.court_code || 'Unknown Court',
                        filed_date: case_.filed_date,
                        case_type: case_.case_type.toUpperCase(),
                        url: case_.pacer_url || '#'
                    }));

                    const partyCases = data.all_results.party_cases.map(case_ => ({
                        id: case_.case_number,
                        title: case_.case_title,
                        court: case_.court_name || case_.court_code || 'Unknown Court',
                        filed_date: case_.filed_date,
                        case_type: case_.case_type.toUpperCase(),
                        url: case_.pacer_url || '#'
                    }));

                    // Combine all cases and sort by filing date (newest first)
                    this.allCases = [...regularCases, ...partyCases];
                    this.sortCasesByDate();
                    this.newCases = this.getRecentCases();

                    // Store merge statistics if available
                    this.mergeStats = data.merge_stats || null;
                } else {
                    console.log('Could not load enhanced_federal_report.json, using demo data');
                    this.allCases = this.getFederalCaseData();
                    this.newCases = this.getRecentCases();
                }
            } catch (error) {
                console.log('Error loading federal case data:', error);
                this.allCases = this.getFederalCaseData();
                this.newCases = this.getRecentCases();
            }

            this.totalPages = Math.ceil(this.allCases.length / this.casesPerPage);
            this.renderInterface();
            this.updateStats();
        }

        sortCasesByDate(ascending = false) {
            this.allCases.sort((a, b) => {
                const dateA = new Date(a.filed_date);
                const dateB = new Date(b.filed_date);
                return ascending ? dateA - dateB : dateB - dateA;
            });
        }

        sortCasesAlphabetically() {
            this.allCases.sort((a, b) => a.title.localeCompare(b.title));
        }

        sortCasesByDistrict() {
            this.allCases.sort((a, b) => a.court.localeCompare(b.court));
        }

        applySortOption(option) {
            switch(option) {
                case 'newest':
                    this.sortCasesByDate(false);
                    break;
                case 'oldest':
                    this.sortCasesByDate(true);
                    break;
                case 'alphabetical':
                    this.sortCasesAlphabetically();
                    break;
                case 'district':
                    this.sortCasesByDistrict();
                    break;
            }
            this.currentPage = 0;
            this.renderRolodex();
            this.updatePageInfo();
            this.saveSessionState();
        }

        getFederalCaseData() {
            return [
                {
                    id: "1:2025cv03381",
                    title: "AFFILIATED FM INSURANCE COMPANY v. HITT CONTRACTING, INC. et al",
                    court: "District of Columbia",
                    filed_date: "2025-09-24",
                    case_type: "CV",
                    url: "https://ecf.dcd.uscourts.gov//cgi-bin/iqquerymenu.pl?285223"
                },
                {
                    id: "1:2025cv03382",
                    title: "CRAFTON v. AMERICAN AIRLINES, INC. et al",
                    court: "District of Columbia",
                    filed_date: "2025-09-24",
                    case_type: "CV",
                    url: "https://ecf.dcd.uscourts.gov//cgi-bin/iqquerymenu.pl?285225"
                },
                {
                    id: "1:2025cv03383",
                    title: "BLOUNT v. CONSTELLIS, LLC",
                    court: "District of Columbia",
                    filed_date: "2025-09-24",
                    case_type: "CV",
                    url: "https://ecf.dcd.uscourts.gov//cgi-bin/iqquerymenu.pl?285232"
                },
                {
                    id: "1:2025cv03385",
                    title: "FREEDOM OF THE PRESS FOUNDATION v. UNITED STATES DEPARTMENT OF HOMELAND SECURITY et al",
                    court: "District of Columbia",
                    filed_date: "2025-09-24",
                    case_type: "CV",
                    url: "https://ecf.dcd.uscourts.gov//cgi-bin/iqquerymenu.pl?285233"
                },
                {
                    id: "1:2025cv03386",
                    title: "FREEDOM OF THE PRESS FOUNDATION v. OFFICE OF THE DIRECTOR OF NATIONAL INTELLIGENCE",
                    court: "District of Columbia",
                    filed_date: "2025-09-24",
                    case_type: "CV",
                    url: "https://ecf.dcd.uscourts.gov//cgi-bin/iqquerymenu.pl?285234"
                },
                {
                    id: "1:2025cv03387",
                    title: "FREEDOM OF THE PRESS FOUNDATION et al v. UNITED STATES DEPARTMENT OF HOMELAND SECURITY et al",
                    court: "District of Columbia",
                    filed_date: "2025-09-24",
                    case_type: "CV",
                    url: "https://ecf.dcd.uscourts.gov//cgi-bin/iqquerymenu.pl?285235"
                },
                {
                    id: "1:2025cv03388",
                    title: "JAIN v. SECRETARY OF STATE, U.S. STATE DEPARTMENT",
                    court: "District of Columbia",
                    filed_date: "2025-09-24",
                    case_type: "CV",
                    url: "https://ecf.dcd.uscourts.gov//cgi-bin/iqquerymenu.pl?285238"
                },
                {
                    id: "1:2025cv03389",
                    title: "HALE v. YMCA OF METROPOLITAN WASHINGTON",
                    court: "District of Columbia",
                    filed_date: "2025-09-24",
                    case_type: "CV",
                    url: "https://ecf.dcd.uscourts.gov//cgi-bin/iqquerymenu.pl?285242"
                },
                {
                    id: "1:2025cv03399",
                    title: "WIGGINS v. DISTRICT OF COLUMBIA et al",
                    court: "District of Columbia",
                    filed_date: "2025-09-24",
                    case_type: "CV",
                    url: "https://ecf.dcd.uscourts.gov//cgi-bin/iqquerymenu.pl?285253"
                }
            ];
        }

        getRecentCases() {
            return this.allCases.slice(0, 5);
        }

        renderInterface() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('main-container');

            if (this.allCases.length === 0) {
                loading.textContent = '>> No federal cases found';
                return;
            }

            loading.style.display = 'none';
            container.style.display = 'flex';

            this.renderRolodex();
            this.renderNewCases();
            this.updatePageInfo();
        }

        renderRolodex() {
            const rolodex = document.getElementById('rolodex');
            rolodex.innerHTML = '';

            const startIndex = this.currentPage * this.casesPerPage;
            const endIndex = Math.min(startIndex + this.casesPerPage, this.allCases.length);
            const pageCases = this.allCases.slice(startIndex, endIndex);

            pageCases.forEach((case_, index) => {
                const card = document.createElement('div');

                // Add case type class for color coding
                const caseTypeClass = case_.case_type.toLowerCase().includes('cr') ? 'criminal' :
                                     case_.case_type.toLowerCase().includes('cv') ? 'civil' : 'other';
                card.className = `card ${caseTypeClass}`;

                const angle = (index / pageCases.length) * 360;
                let radius = 150;

                // Adjusted radius for landscape mobile
                if (window.innerHeight <= 500 && window.orientation !== undefined) {
                    radius = 155;
                }

                card.style.transform = `translateX(-50%) rotateX(${angle}deg) translateZ(${radius}px)`;

                const title = case_.title;
                const vsMatch = title.match(/^(.+?)\s+v\.?\s+(.+)$/i);

                card.innerHTML = `
                    <div class="card-content">
                        <div class="case-info">
                            <div class="case-number">${case_.id}</div>
                            <div class="case-title">${vsMatch ? `${vsMatch[1]} v. ${vsMatch[2]}` : title}</div>
                            <div class="case-meta">
                                <span>${case_.case_type}</span>
                                <span>${case_.court}</span>
                                <span>${case_.filed_date}</span>
                            </div>
                        </div>
                    </div>
                `;

                // Long-press tracking
                let longPressTimer;
                let longPressTriggered = false;

                // Single click - open URL directly
                card.addEventListener('click', (e) => {
                    if (longPressTriggered) return;

                    e.preventDefault();
                    e.stopPropagation();

                    // If this is the selected card and modal is open, dismiss modal
                    if (this.isCardSelected && this.selectedCard === card) {
                        this.dismissMenu();
                        return;
                    }

                    // If modal is open for different card, ignore click
                    if (this.isCardSelected) return;

                    // Normal behavior: open URL directly
                    if (case_.url && case_.url !== '#') {
                        window.open(case_.url, '_blank');
                    } else {
                        this.showNotification('No PACER URL available for this case');
                    }
                });

                // Right-click - show copy menu
                card.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showCopyMenu(case_, card);
                });

                // Touch events for mobile long-press
                card.addEventListener('touchstart', (e) => {
                    longPressTriggered = false;
                    longPressTimer = setTimeout(() => {
                        longPressTriggered = true;
                        this.showCopyMenu(case_, card);
                        e.preventDefault();
                    }, 500);
                });

                card.addEventListener('touchend', (e) => {
                    clearTimeout(longPressTimer);
                    if (longPressTriggered) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });

                card.addEventListener('touchmove', () => {
                    clearTimeout(longPressTimer);
                });

                rolodex.appendChild(card);
            });

            this.updateRolodexRotation();
        }

        renderNewCases() {
            const newCasesList = document.getElementById('new-cases-list');
            newCasesList.innerHTML = '';

            if (this.newCases.length === 0) {
                newCasesList.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No recent filings</div>';
                return;
            }

            this.newCases.forEach(case_ => {
                const item = document.createElement('div');
                item.className = 'new-case-item';

                item.addEventListener('click', () => {
                    if (case_.url && case_.url !== '#') {
                        window.open(case_.url, '_blank');
                    } else {
                        this.showNotification('No PACER URL available for this case');
                    }
                });

                const title = case_.title;
                const vsMatch = title.match(/^(.+?)\s+v\.?\s+(.+)$/i);

                item.innerHTML = `
                    <div class="new-case-number">${case_.id}</div>
                    <div class="new-case-title">${vsMatch ? `${vsMatch[1]} v. ${vsMatch[2]}` : title}</div>
                    <div class="new-case-date">${case_.filed_date} • ${case_.court}</div>
                `;

                newCasesList.appendChild(item);
            });
        }

        setupRolodex() {
            this.updateRolodexRotation();
        }

        updateRolodexRotation() {
            const rolodex = document.getElementById('rolodex');
            rolodex.style.transform = `translate(-50%, -50%) rotateX(${this.currentRotation}deg)`;
        }

        startMomentum() {
            if (Math.abs(this.velocity) < 0.01) return;

            const friction = 0.98;
            let currentVelocity = this.velocity * -3.0;

            const animate = () => {
                currentVelocity *= friction;
                this.currentRotation += currentVelocity;
                this.updateRolodexRotation();

                if (Math.abs(currentVelocity) > 0.01) {
                    requestAnimationFrame(animate);
                } else {
                    this.saveSessionState();
                }
            };

            requestAnimationFrame(animate);
        }

        setupControls() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            prevBtn.addEventListener('click', () => {
                if (this.currentPage > 0) {
                    this.currentPage--;
                    this.renderRolodex();
                    this.updatePageInfo();
                    this.saveSessionState();
                }
            });

            nextBtn.addEventListener('click', () => {
                if (this.currentPage < this.totalPages - 1) {
                    this.currentPage++;
                    this.renderRolodex();
                    this.updatePageInfo();
                    this.saveSessionState();
                }
            });
        }

        updatePageInfo() {
            document.getElementById('current-page').textContent = this.currentPage + 1;
            document.getElementById('total-pages').textContent = this.totalPages;
        }

        setupInteractions() {
            const rolodexWrapper = document.querySelector('.rolodex-wrapper');

            rolodexWrapper.addEventListener('mousedown', (e) => {
                if (this.isRolodexLocked) return;
                this.isDragging = true;
                this.startY = e.clientY;
                this.startRotation = this.currentRotation;
                e.preventDefault();
                e.stopPropagation();
            });

            document.addEventListener('mousemove', (e) => {
                if (!this.isDragging || this.isRolodexLocked) return;

                e.preventDefault();
                e.stopPropagation();
                const deltaY = e.clientY - this.startY;
                const currentTime = Date.now();

                if (this.lastMoveTime) {
                    const timeDiff = currentTime - this.lastMoveTime;
                    const yDiff = e.clientY - this.lastMoveY;
                    this.velocity = yDiff / timeDiff;
                }

                this.lastMoveTime = currentTime;
                this.lastMoveY = e.clientY;
                this.currentRotation = this.startRotation - (deltaY * 0.8);
                this.updateRolodexRotation();
            });

            document.addEventListener('mouseup', () => {
                if (this.isDragging) {
                    this.isDragging = false;
                    this.startMomentum();
                }
            });

            rolodexWrapper.addEventListener('touchstart', (e) => {
                // Immediate stop on touch - like a real spinner
                this.velocity = 0;
                
                if (this.isRolodexLocked) return;
                this.isDragging = true;
                this.startY = e.touches[0].clientY;
                this.startRotation = this.currentRotation;
                e.preventDefault();
                e.stopPropagation();
            }, { passive: false });

            document.addEventListener('touchmove', (e) => {
                if (!this.isDragging || this.isRolodexLocked) return;

                e.preventDefault();
                e.stopPropagation();
                const deltaY = e.touches[0].clientY - this.startY;
                const currentTime = Date.now();

                if (this.lastMoveTime) {
                    const timeDiff = currentTime - this.lastMoveTime;
                    const yDiff = e.touches[0].clientY - this.lastMoveY;
                    this.velocity = yDiff / timeDiff;
                }

                this.lastMoveTime = currentTime;
                this.lastMoveY = e.touches[0].clientY;
                this.currentRotation = this.startRotation - (deltaY * 0.8);
                this.updateRolodexRotation();
            }, { passive: false });

            document.addEventListener('touchend', () => {
                if (this.isDragging) {
                    this.isDragging = false;
                    this.startMomentum();
                }
            });

            rolodexWrapper.addEventListener('wheel', (e) => {
                if (this.isRolodexLocked) return;
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                this.currentRotation += e.deltaY * 0.15;
                this.updateRolodexRotation();
                this.saveSessionState();
            }, { passive: false });
        }

        updateStats() {
            const caseCount = document.getElementById('case-count');
            const newCasesCount = document.getElementById('new-cases-count');
            const lastUpdated = document.getElementById('last-updated');

            caseCount.textContent = this.allCases.length;

            // Display new cases count from merge stats if available
            if (this.mergeStats && this.mergeStats.new_cases_added !== undefined) {
                newCasesCount.textContent = `${this.mergeStats.new_cases_added} new`;
                newCasesCount.title = `${this.mergeStats.duplicates_skipped} duplicates skipped`;
            } else {
                newCasesCount.textContent = '0 new';
                newCasesCount.title = 'No merge data available';
            }

            lastUpdated.textContent = new Date().toLocaleTimeString();
        }

        showCopyMenu(caseData, cardElement) {
            // Dismiss any existing modal first
            this.dismissMenu();

            // Lock rolodex
            this.isRolodexLocked = true;
            this.isCardSelected = true;
            this.selectedCard = cardElement;
            this.selectedCaseData = caseData;

            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.id = 'modal-overlay';

            // Create card clone for modal
            const modalCard = document.createElement('div');
            modalCard.className = 'modal-card';
            modalCard.innerHTML = cardElement.innerHTML;

            // Create menu
            const menu = document.createElement('div');
            menu.className = 'copy-menu';
            menu.innerHTML = `
                <div class="copy-buttons">
                    <button onclick="rolodex.copyToClipboard('${caseData.id}', 'Case Number')">Copy Case #</button>
                    <button onclick="rolodex.copyToClipboard('${caseData.title.replace(/'/g, "\\'")}', 'Case Title')">Copy Title</button>
                    <button onclick="rolodex.copyToClipboard('${caseData.court}', 'Court')">Copy Court</button>
                    <button onclick="rolodex.addToSummaryQueue(rolodex.selectedCaseData); rolodex.dismissMenu();">📝 Summary Queue</button>
                    <button onclick="rolodex.addSavedCase(rolodex.selectedCaseData); rolodex.dismissMenu();">+ Save Case</button>
                    <button onclick="window.open('${caseData.url}', '_blank'); rolodex.dismissMenu();">Open PACER</button>
                </div>
            `;

            // Assemble modal
            overlay.appendChild(modalCard);
            overlay.appendChild(menu);

            // Add click-away dismissal
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    this.dismissMenu();
                }
            });

            // Show modal
            document.body.appendChild(overlay);

            // Lock rolodex
            document.querySelector('.rolodex-wrapper').classList.add('rolodex-locked');
        }

        dismissMenu() {
            // Remove modal overlay
            const overlay = document.getElementById('modal-overlay');
            if (overlay) {
                overlay.remove();
            }

            // Unlock rolodex
            this.isRolodexLocked = false;
            this.isCardSelected = false;
            this.selectedCard = null;
            this.selectedCaseData = null;
            this.isDragging = false;

            // Remove lock class
            document.querySelector('.rolodex-wrapper').classList.remove('rolodex-locked');
        }

        copyToClipboard(text, label) {
            navigator.clipboard.writeText(text).then(() => {
                this.showNotification(`${label} copied to clipboard`);
                this.dismissMenu(); // Close menu after action
            });
        }

        addToSummaryQueue(caseData) {
            // Get existing summary queue from localStorage
            let summaryQueue = [];
            try {
                const saved = localStorage.getItem('summaryQueue');
                if (saved) {
                    summaryQueue = JSON.parse(saved);
                }
            } catch (e) {
                console.log('Could not load summary queue');
            }

            // Add case if not already in queue
            if (!summaryQueue.find(c => c.id === caseData.id)) {
                summaryQueue.push({
                    ...caseData,
                    addedAt: new Date().toISOString()
                });
                localStorage.setItem('summaryQueue', JSON.stringify(summaryQueue));
                this.showNotification(`Added to Summary Queue (${summaryQueue.length} total)`);
            } else {
                this.showNotification('Case already in Summary Queue');
            }
        }

        applyFilters() {
            const caseType = document.getElementById('filter-case-type').value;
            const district = document.getElementById('filter-district').value.toLowerCase();
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;

            // Filter allCases based on criteria
            let filtered = [...this.allCases];

            if (caseType !== 'all') {
                filtered = filtered.filter(c => {
                    const type = c.case_type.toLowerCase();
                    if (caseType === 'criminal') return type.includes('cr');
                    if (caseType === 'civil') return type.includes('cv');
                    return !type.includes('cr') && !type.includes('cv');
                });
            }

            if (district) {
                filtered = filtered.filter(c => c.court.toLowerCase().includes(district));
            }

            if (dateFrom) {
                filtered = filtered.filter(c => c.filed_date >= dateFrom);
            }

            if (dateTo) {
                filtered = filtered.filter(c => c.filed_date <= dateTo);
            }

            // Store original if not already stored
            if (!this.allCasesOriginal) {
                this.allCasesOriginal = [...this.allCases];
            }

            this.allCases = filtered;
            this.totalPages = Math.ceil(this.allCases.length / this.casesPerPage);
            this.currentPage = 0;
            this.renderRolodex();
            this.updatePageInfo();
            this.updateStats();
            this.closeAllDropdowns();
            this.showNotification(`Showing ${filtered.length} filtered cases`);
        }

        clearFilters() {
            if (this.allCasesOriginal) {
                this.allCases = [...this.allCasesOriginal];
                this.allCasesOriginal = null;
            }

            // Reset filter inputs
            document.getElementById('filter-case-type').value = 'all';
            document.getElementById('filter-district').value = '';
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';

            this.totalPages = Math.ceil(this.allCases.length / this.casesPerPage);
            this.currentPage = 0;
            this.renderRolodex();
            this.updatePageInfo();
            this.updateStats();
            this.closeAllDropdowns();
            this.showNotification('Filters cleared');
        }

        showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'copy-notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        setupMatrixBackground() {
            const matrixBg = document.getElementById('matrix-bg');
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()';

            setInterval(() => {
                if (Math.random() > 0.95) {
                    const char = document.createElement('div');
                    char.textContent = chars.charAt(Math.random() * chars.length);
                    char.style.cssText = `
                        position: absolute;
                        color: #003300;
                        font-family: 'Courier New', monospace;
                        font-size: 12px;
                        left: ${Math.random() * 100}%;
                        top: -20px;
                        animation: matrix-fall 3s linear forwards;
                    `;

                    matrixBg.appendChild(char);

                    setTimeout(() => {
                        if (char.parentNode) {
                            char.parentNode.removeChild(char);
                        }
                    }, 3000);
                }
            }, 100);
        }
    }

    window.addEventListener('load', () => {
        new FederalCaseRolodex();
    });
    </script>
</body>
</html>
